``markdown
# 插件开发文档：astrbot_plugin_smart_reminder

## 插件简介

`astrbot_plugin_smart_reminder` 是一款基于对话上下文的智能提醒插件。它不仅是一个简单的定时器，更是一个能够“听懂”对话的智能助理。

该插件会在每一轮对话结束后，自动获取最近的对话历史（默认10轮），调用指定的大语言模型（LLM）进行分析。如果模型判断用户表达了未来的意图或需要提醒的事项，插件将自动提取时间点和提醒内容并创建定时任务。

当提醒时间到达时，插件不会简单地发送通知，而是将提醒内容**伪装成用户发送的一条新消息**注入到 AstrBot 的处理流程中。这样做的好处是，Bot 会根据当前的人设（Persona）对提醒内容做出自然的反应和回复，从而提供更加沉浸式的交互体验。

## 功能说明

1.  **智能上下文分析**：
    *   自动监听对话流程，在回复结束后异步分析历史消息。
    *   提取对话中隐含的提醒需求（例如：“我十分钟后要出门”、“明天早上叫我起床”）。
2.  **自定义模型指定**：
    *   允许用户从 AstrBot 已配置的 LLM 提供商（Provider）中，指定一个专门用于分析提醒任务的模型。这使得你可以使用更廉价或更擅长逻辑分析的模型来处理后台任务，而不影响主对话模型。
3.  **沉浸式提醒触发**：
    *   任务触发时，模拟用户发送消息（例如：“提醒时间到了：该出门了”），触发 Bot 主动回复。
4.  **实时任务管理**：
    *   提供指令组用于查看、删除或手动添加提醒任务。
5.  **自定义过滤机制**：
    *   支持设置“忽略关键词”，当用户最新消息包含特定词汇时（如“取消”、“别提醒”），跳过当次智能分析，节省 Token 消耗。
6.  **智能维护**：
    *   插件启动时自动清理数据库中已过期但未执行的任务，保持任务队列整洁。

## 插件流程

本插件的工作流程设计为**旁路分析**与**事件注入**相结合的模式，具体逻辑如下：

### 1. 消息监听与过滤
*   插件注册了 `after_message_sent`（消息发送后）钩子。
*   当 Bot 回复用户后，插件首先检查用户发送的最新消息是否包含配置中的**忽略关键词**。
*   如果包含关键词，流程终止；否则进入下一步。

### 2. 上下文分析 (LLM Processing)
*   插件获取当前会话的 `unified_msg_origin`，并检索最近 **10轮**（可配置）的历史对话记录。
*   插件读取配置中指定的 **分析用模型 ID (analysis_model_id)**。
*   将历史记录与用户自定义的 **System Prompt (提示词)** 组装，发送给指定的 LLM。提示词要求 LLM 输出 JSON 格式的结果，包含 `should_remind` (布尔值), `remind_time` (时间字符串), `remind_content` (内容)。

### 3. 任务调度 (Scheduling)
*   如果 LLM 返回需要提醒，解析时间并计算延迟。
*   使用 `apscheduler` 库将任务注册到调度器中，并持久化存储到本地数据文件（确保重启不丢失）。

### 4. 提醒触发与注入 (Trigger & Injection)
*   当设定时间到达时，调度器执行回调函数。
*   回调函数构建一个新的 `AstrMessageEvent`，将发送者设为原用户，消息内容构造为 `[智能提醒] {remind_content}`。
*   该事件被注入到 AstrBot 的事件管线中，就像用户刚刚发送了这条消息一样。
*   Bot 的主逻辑捕获该消息，根据当前加载的人格（Persona）进行回复。

## 使用方法

插件安装并加载后，主要通过指令进行管理。智能分析功能默认在后台运行。

### 指令列表

所有指令均以 `/reminder` 开头（或指令前缀）。

#### 1. 查看任务列表
查看当前会话下所有待执行的提醒任务。